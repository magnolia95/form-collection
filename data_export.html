<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导出收集数据</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #333; }
        button { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; }
        button:hover { background-color: #45a049; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
    </style>
</head>
<body>
    <h1>收集的媒体记者信息</h1>
    <button onclick="exportCSV()">导出为CSV</button>
    <button onclick="clearData()">清除所有数据</button>
    
    <div id="dataTable"><p>正在加载数据...</p></div>
    
    <script>
        // ==================== 修改区域 START ====================
        // 请将下面的网址替换为你从Google Apps Script部署后得到的Web应用网址
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwNCZUg5wtiWdlrd0AqnJgJtEo9YdtVPmqxhvITsWmNDwaSO4Qc0NXE-YHIyf-8HFIr/exec";
        let collectedData = []; // 用于存储从服务器获取的数据
        // ==================== 修改区域 END ======================

        window.onload = function() {
            displayData();
        };
        
        function displayData() {
            const dataDiv = document.getElementById("dataTable");
            dataDiv.innerHTML = "<p>正在加载数据...</p>";

            // ==================== 修改区域 START ====================
            // 从Google Script获取数据
            fetch(SCRIPT_URL)
                .then(response => response.json())
                .then(data => {
                    collectedData = data.reverse(); //  让最新数据在最前面
                    
                    if (collectedData.length === 0) {
                        dataDiv.innerHTML = "<p>尚未收集到任何数据</p>";
                        return;
                    }
                    
                    let tableHTML = `
                        <table>
                            <tr>
                                <th>姓名</th><th>电子邮箱</th><th>电话号码</th><th>媒体机构</th><th>国家/地区</th><th>兴趣领域</th><th>提交时间</th>
                            </tr>`;
                    
                    collectedData.forEach(entry => {
                        tableHTML += `
                            <tr>
                                <td>${entry["姓名"] || "-"}</td>
                                <td>${entry["电子邮箱"] || "-"}</td>
                                <td>${entry["电话号码"] || "-"}</td>
                                <td>${entry["媒体机构"] || "-"}</td>
                                <td>${entry["国家/地区"] || "-"}</td>
                                <td>${entry["兴趣领域"] || "-"}</td>
                                <td>${entry["提交时间"] || "-"}</td>
                            </tr>`;
                    });
                    
                    tableHTML += "</table>";
                    dataDiv.innerHTML = tableHTML;
                })
                .catch(error => {
                    console.error("加载数据失败:", error);
                    dataDiv.innerHTML = "<p>加载数据失败，请检查脚本URL或网络连接。</p>";
                });
            // ==================== 修改区域 END ======================
        }
        
        function exportCSV() {
            if (collectedData.length === 0) {
                alert("没有数据可导出");
                return;
            }
            
            // CSV 表头，使用谷歌表格中的表头
            let csvContent = Object.keys(collectedData[0]).join(",") + "\n";
            
            collectedData.forEach(entry => {
                const row = Object.values(entry).map(value => `"${String(value).replace(/"/g, '""')}"`).join(",");
                csvContent += row + "\n";
            });
            
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "媒体记者信息_" + new Date().toISOString().slice(0,10) + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function clearData() {
            if (confirm("确定要删除所有收集的数据吗？此操作不可恢复。")) {
                // ==================== 修改区域 START ====================
                // 发送清除数据的请求
                fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'clear' })
                })
                .then(() => {
                    alert("所有数据已清除");
                    displayData(); // 重新加载数据（应显示为空）
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("清除失败，请稍后重试。");
                });
                // ==================== 修改区域 END ======================
            }
        }
    </script>
</body>
</html>